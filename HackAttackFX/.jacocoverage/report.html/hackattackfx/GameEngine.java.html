<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GameEngine.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;HackAttackFX&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">hackattackfx</a> &gt; <span class="el_source">GameEngine.java</span></div><h1>GameEngine.java</h1><pre class="source lang-java linenums">package hackattackfx;

import hackattackfx.GameEngine.OnExecuteTick;
import hackattackfx.exceptions.InvalidModuleEnumException;
import hackattackfx.enums.ModuleName;
import java.awt.Point;
import javafx.scene.input.*;
import java.util.ArrayList;
import hackattackfx.exceptions.*;
import java.awt.event.MouseListener;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.Timer;
import java.util.TimerTask;
import java.util.logging.Level;
import java.util.logging.Logger;
import javafx.collections.ObservableList;
import javafx.event.EventHandler;
import javafx.geometry.Point2D;
import javafx.scene.Node;
import javafx.scene.image.ImageView;
import javafx.scene.layout.AnchorPane;

/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * This is the main engine that executes the ticks. Every object that wants to be notified when a tick occurs,
 * should register to this object's {@link GameEngine.OnExecuteTick} interface.
 * 
 * @author juleskreutzer, Jasper Rouwhorst
 */
public class GameEngine extends Thread implements MouseListener {

    /**
     * This interface is used to notify every listening object when a tick has occured.
     */
    public interface OnExecuteTick{
        /**
         * Executed when a tick occured
         * @param elapsedtime The elapsed time of the running game in milliseconds
         */
        void onTick(long elapsedtime);
    }
    
    /**
     * This interface is used to notify every listening object when a tick has been ended.
     */
    public interface OnCompleteTick{
        void tickComplete(long elapsedtime);
    }
    
    private static GameEngine instance;
    
    private GraphicsEngine graphicsEngine;
    private Map map;
    private ArrayList&lt;Wave&gt; waveList;
    private Wave currentWave;
    // The elapsed game time a wave has started
    private long lastWaveStart;
    // The elapsed game time a wave has ended
    private long lastWaveEnd;
    private int waveNumber;
    private Player playerA;
    private Player playerB;
    private String playerAName;
    private String playerBName;
    
    private boolean gameRunning;
    private Spell selectedSpell;
    private Module selectedModule;
    
    private List&lt;OnCompleteTick&gt; tickCompleteListeners;
    private List&lt;OnCompleteTick&gt; unsubscribedCompleteListeners;
    private List&lt;OnExecuteTick&gt; listeners;
    private List&lt;OnExecuteTick&gt; unsubscribedListeners;
    
<span class="fc" id="L82">    private SpawnTargetImage st = null;</span>

<span class="fc" id="L84">    private GameEngine(){</span>
<span class="fc" id="L85">        instance = this;</span>
        
<span class="nc" id="L87">        initialize();</span>
<span class="nc" id="L88">    }</span>
    
    public static GameEngine getInstance(){
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        return instance == null ? new GameEngine() : instance;</span>
    }
    
    private void initialize(){
        // This makes a daemon thread of the gameengine. This means that this thread will not prevent the JVM from shutting down. 
        // This is implemented due previous bugs that kept the gameengine thread running while the game was closed.
<span class="fc" id="L97">        setDaemon(true);</span>
        
<span class="nc" id="L99">        graphicsEngine = GraphicsEngine.getInstance();</span>
<span class="nc" id="L100">        map = Map.getInstance();</span>
<span class="nc" id="L101">        tickCompleteListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">        unsubscribedCompleteListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L103">        listeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L104">        unsubscribedListeners = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L105">        waveList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L106">        playerA = new Player(100, Data.playerAName, 100, new Point(0,50));</span>
<span class="nc" id="L107">        playerB = new Player(100, Data.playerBName, 100, new Point(100,50));</span>
<span class="nc" id="L108">        gameRunning = false;</span>
<span class="nc" id="L109">        waveNumber = 0;</span>
<span class="nc" id="L110">        lastWaveStart = GameTime.getElapsedTime();</span>
<span class="nc" id="L111">        preStart();</span>
<span class="nc" id="L112">        startGame();</span>
<span class="nc" id="L113">    }</span>
    
    /**
     * Mostly used to draw the initial components like the bases and roads and event handlers
     */
    private void preStart(){
<span class="nc" id="L119">        graphicsEngine.drawRoad(map.getRoad());</span>
        
        // Initialize all GUI buttons
<span class="nc" id="L122">        ImageView sniperav = (ImageView)graphicsEngine.getNode(&quot;buildSniperAV&quot;,null);</span>
<span class="nc" id="L123">        sniperav.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>
 
            @Override
            public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L127">                st = graphicsEngine.drawModuleSpawnTarget(ModuleName.SNIPER_ANTIVIRUS);</span>
                
<span class="nc" id="L129">                graphicsEngine.getScene().setOnMouseMoved(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>

                    @Override
                    public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L133">                        st.setX(event.getSceneX() - (st.getImage().getWidth()/2));</span>
<span class="nc" id="L134">                        st.setY(event.getSceneY() - (st.getImage().getHeight()/2));</span>
<span class="nc" id="L135">                    }</span>
                });
                // Set a listener for a second click to occur
<span class="nc" id="L138">                st.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>

                    @Override
                    public void handle(MouseEvent event) {
                        
<span class="nc" id="L143">                        Point position = new Point((int)event.getSceneX(), (int)event.getSceneY());</span>
                        try {
                            try {
<span class="nc" id="L146">                                int x = (int)st.getX();</span>
<span class="nc" id="L147">                                int y = (int)st.getY();</span>
                                
                                
<span class="nc bnc" id="L150" title="All 2 branches missed.">                                if(!isPointInNode(x, y, (int)st.getImage().getWidth(), (int)st.getImage().getHeight()))</span>
                                {   
<span class="nc" id="L152">                                    Defense defense = playerA.buildDefense(new Defense(Data.DEFAULT_MODULE_DEFENSE_SNIPER_1, position, 50, 50));</span>
<span class="nc" id="L153">                                    graphicsEngine.spawn(defense);</span>
<span class="nc" id="L154">                                    graphicsEngine.deSpawn(st);</span>
<span class="nc" id="L155">                                    defense.activate();</span>
<span class="nc" id="L156">                                }</span>
                                else
                                {
<span class="nc" id="L159">                                    graphicsEngine.showError(&quot;You are not allowed to build here.&quot;);</span>
                                }
<span class="nc" id="L161">                            } catch (DuplicateSpawnException | InvalidObjectException ex) {</span>
<span class="nc" id="L162">                                Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L163">                            } catch (NotEnoughBitcoinsException ex) {</span>
<span class="nc" id="L164">                                graphicsEngine.showError(ex.getMessage());</span>
<span class="nc" id="L165">                            } </span>
<span class="nc" id="L166">                        } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L167">                            Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L168">                        }</span>
<span class="nc" id="L169">                    }</span>
                });
<span class="nc" id="L171">            }</span>
            
        });
<span class="nc" id="L174">        sniperav.setOnMouseEntered(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
                try {
<span class="nc" id="L179">                    Module module = new Defense(Data.DEFAULT_MODULE_DEFENSE_SNIPER_1, null, 0,0);</span>
<span class="nc" id="L180">                    graphicsEngine.drawModuleStats(module);</span>
<span class="nc" id="L181">                } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L182">                    Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L183">                }</span>
<span class="nc" id="L184">            }</span>
        });
<span class="nc" id="L186">        sniperav.setOnMouseExited(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
<span class="nc" id="L190">                graphicsEngine.drawModuleStats(null);</span>
<span class="nc" id="L191">            }</span>
        });
<span class="nc" id="L193">        </span>
<span class="nc" id="L194">        ImageView scaleav = (ImageView)graphicsEngine.getNode(&quot;buildScaleAV&quot;,null);</span>
<span class="nc" id="L195">        scaleav.setOnMouseClicked(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>
 
<span class="nc" id="L197">            @Override</span>
<span class="nc" id="L198">            public void handle(javafx.scene.input.MouseEvent event) {</span>
<span class="nc" id="L199">                st = graphicsEngine.drawModuleSpawnTarget(ModuleName.SCALE_ANTIVIRUS);</span>
<span class="nc" id="L200">                graphicsEngine.getScene().setOnMouseMoved(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>

                    @Override
<span class="nc" id="L203">                    public void handle(javafx.scene.input.MouseEvent event) {</span>
<span class="nc" id="L204">                        st.setX(event.getSceneX() - (st.getImage().getWidth()/2));</span>
<span class="nc" id="L205">                        st.setY(event.getSceneY() - (st.getImage().getHeight()/2));</span>

<span class="nc" id="L207">                    }</span>
                });
                // Set a listener for a second click to occur
<span class="nc" id="L210">                st.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>
<span class="nc" id="L211"></span>
<span class="nc" id="L212">                    @Override</span>
                    public void handle(MouseEvent event) {
<span class="nc" id="L214">                        Point position = new Point((int)event.getSceneX(), (int)event.getSceneY());</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                        try {</span>
                            
<span class="nc" id="L217">                            try {</span>
<span class="nc" id="L218">                                int x = (int)st.getX();</span>
<span class="nc" id="L219">                                int y = (int)st.getY();</span>
<span class="nc" id="L220">                                </span>
<span class="nc" id="L221">                                </span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                                if(!isPointInNode(x, y, (int)st.getImage().getWidth(), (int)st.getImage().getHeight()))</span>
<span class="nc" id="L223">                                {</span>
<span class="nc" id="L224">                                    Defense defense = playerA.buildDefense(new Defense(Data.DEFAULT_MODULE_DEFENSE_SCALE_1, position, 50, 50));</span>
<span class="nc" id="L225">                                    graphicsEngine.spawn(defense);</span>
<span class="nc" id="L226">                                    graphicsEngine.deSpawn(st);</span>
<span class="nc" id="L227">                                    defense.activate();</span>
<span class="nc" id="L228">                                }</span>
                                else{
<span class="nc" id="L230">                                    graphicsEngine.showError(&quot;You are not allowed to build here.&quot;);</span>
<span class="nc" id="L231">                                }</span>
<span class="nc" id="L232">                            } catch (DuplicateSpawnException | InvalidObjectException ex) {</span>
<span class="nc" id="L233">                                Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L234">                            } </span>
<span class="nc" id="L235">                            </span>
                            
<span class="nc" id="L237">                        } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L238">                            Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L239">                        } catch (NotEnoughBitcoinsException ex) {</span>
<span class="nc" id="L240">                            graphicsEngine.showError(ex.getMessage());</span>
<span class="nc" id="L241">                        }</span>
<span class="nc" id="L242">                    }</span>
                
                });
<span class="nc" id="L245">            }</span>
            
        });
<span class="nc" id="L248">        scaleav.setOnMouseEntered(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
                try {
<span class="nc" id="L253">                    Module module = new Defense(Data.DEFAULT_MODULE_DEFENSE_SCALE_1, null, 0,0);</span>
<span class="nc" id="L254">                    graphicsEngine.drawModuleStats(module);</span>
<span class="nc" id="L255">                } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L256">                    Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L257">                }</span>
<span class="nc" id="L258">            }</span>
        });
<span class="nc" id="L260">        scaleav.setOnMouseExited(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
<span class="nc" id="L264">                graphicsEngine.drawModuleStats(null);</span>
<span class="nc" id="L265">            }</span>
        });
<span class="nc" id="L267">        </span>
<span class="nc" id="L268">        ImageView bottlecapav = (ImageView)graphicsEngine.getNode(&quot;buildBottlecapAV&quot;,null);</span>
<span class="nc" id="L269">        bottlecapav.setOnMouseClicked(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>
<span class="nc" id="L270"> </span>
            @Override
            public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L273">                st = graphicsEngine.drawModuleSpawnTarget(ModuleName.BOTTLECAP_ANTIVIRUS);</span>
<span class="nc" id="L274">                graphicsEngine.getScene().setOnMouseMoved(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>

                    @Override
                    public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L278">                        st.setX(event.getSceneX() - (st.getImage().getWidth()/2));</span>
<span class="nc" id="L279">                        st.setY(event.getSceneY() - (st.getImage().getHeight()/2));</span>

<span class="nc" id="L281">                    }</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">                });</span>
                // Set a listener for a second click to occur
<span class="nc" id="L284">                st.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>
<span class="nc" id="L285"></span>
<span class="nc" id="L286">                    @Override</span>
<span class="nc" id="L287">                    public void handle(MouseEvent event) {</span>
<span class="nc" id="L288">                        Point position = new Point((int)event.getSceneX(), (int)event.getSceneY());</span>
                        try {
                            
<span class="nc" id="L291">                            try {</span>
<span class="nc" id="L292">                                int x = (int)st.getX();</span>
<span class="nc" id="L293">                                int y = (int)st.getY();</span>
<span class="nc" id="L294">                                </span>
<span class="nc" id="L295">                                </span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">                                if(!isPointInNode(x, y, (int)st.getImage().getWidth(), (int)st.getImage().getHeight()))</span>
                                {
<span class="nc" id="L298">                                    Defense defense = playerA.buildDefense(new Defense(Data.DEFAULT_MODULE_DEFENSE_BOTTLECAP_1, position, 50, 50));</span>
<span class="nc" id="L299">                                    graphicsEngine.spawn(defense);</span>
<span class="nc" id="L300">                                    graphicsEngine.deSpawn(st);</span>
<span class="nc" id="L301">                                    defense.activate();</span>
<span class="nc" id="L302">                                }</span>
<span class="nc" id="L303">                                else</span>
<span class="nc" id="L304">                                {</span>
<span class="nc" id="L305">                                    graphicsEngine.showError(&quot;You are not allowed to build here.&quot;);</span>
                                }
<span class="nc" id="L307">                            } catch (DuplicateSpawnException | InvalidObjectException ex) {</span>
<span class="nc" id="L308">                                Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L309">                            }</span>
                            
                            
<span class="nc" id="L312">                        } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L313">                            Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L314">                        } catch (NotEnoughBitcoinsException ex)</span>
                        {
<span class="nc" id="L316">                            graphicsEngine.showError(ex.getMessage());</span>
<span class="nc" id="L317">                        }</span>
<span class="nc" id="L318">                    }</span>
                
                });
<span class="nc" id="L321">            }</span>
            
        });
<span class="nc" id="L324">        bottlecapav.setOnMouseEntered(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
                try {
<span class="nc" id="L329">                    Module module = new Defense(Data.DEFAULT_MODULE_DEFENSE_BOTTLECAP_1, null, 0,0);</span>
<span class="nc" id="L330">                    graphicsEngine.drawModuleStats(module);</span>
<span class="nc" id="L331">                } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L332">                    Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L333">                }</span>
<span class="nc" id="L334">            }</span>
        });
<span class="nc" id="L336">        bottlecapav.setOnMouseExited(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
<span class="nc" id="L340">                graphicsEngine.drawModuleStats(null);</span>
<span class="nc" id="L341">            }</span>
        });
        
<span class="nc" id="L344">        ImageView muscleav = (ImageView)graphicsEngine.getNode(&quot;buildMuscleAV&quot;,null);</span>
<span class="nc" id="L345">        muscleav.setOnMouseClicked(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>
 
            @Override
            public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L349">                st = graphicsEngine.drawModuleSpawnTarget(ModuleName.MUSCLE_ANTIVIRUS);</span>
<span class="nc" id="L350">                graphicsEngine.getScene().setOnMouseMoved(new EventHandler&lt;javafx.scene.input.MouseEvent&gt;(){</span>

                    @Override
                    public void handle(javafx.scene.input.MouseEvent event) {
<span class="nc" id="L354">                        st.setX(event.getSceneX() - (st.getImage().getWidth()/2));</span>
<span class="nc" id="L355">                        st.setY(event.getSceneY() - (st.getImage().getHeight()/2));</span>

<span class="nc" id="L357">                    }</span>
                });
                // Set a listener for a second click to occur
<span class="nc" id="L360">                st.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>

                    @Override
                    public void handle(MouseEvent event) {
<span class="nc" id="L364">                        Point position = new Point((int)event.getSceneX(), (int)event.getSceneY());</span>
                        try {
                            
                            try {
<span class="nc" id="L368">                                int x = (int)st.getX();</span>
<span class="nc" id="L369">                                int y = (int)st.getY();</span>
                                
<span class="nc bnc" id="L371" title="All 2 branches missed.">                                if(!isPointInNode(x, y, (int)st.getImage().getWidth(), (int)st.getImage().getHeight()))</span>
                                {
<span class="nc" id="L373">                                    Defense defense = playerA.buildDefense(new Defense(Data.DEFAULT_MODULE_DEFENSE_MUSCLE_1, position, 50, 50));</span>
<span class="nc" id="L374">                                    graphicsEngine.spawn(defense);</span>
<span class="nc" id="L375">                                    graphicsEngine.deSpawn(st);</span>
<span class="nc" id="L376">                                    defense.activate();</span>
<span class="nc" id="L377">                                }</span>
                                else
                                {
<span class="nc" id="L380">                                    graphicsEngine.showError(&quot;You are not allowed to build here.&quot;);</span>
                                }
<span class="nc" id="L382">                            } catch (DuplicateSpawnException | InvalidObjectException ex) {</span>
<span class="nc" id="L383">                                Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L384">                            }</span>
                            
                            
<span class="nc" id="L387">                        } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L388">                            Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L389">                        } catch (NotEnoughBitcoinsException ex)</span>
                        {
<span class="nc" id="L391">                            graphicsEngine.showError(ex.getMessage());</span>
<span class="nc" id="L392">                        }</span>
<span class="nc" id="L393">                    }</span>
                
                });
<span class="nc" id="L396">            }</span>
            
        });
<span class="nc" id="L399">        muscleav.setOnMouseEntered(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
                try {
<span class="nc" id="L404">                    Module module = new Defense(Data.DEFAULT_MODULE_DEFENSE_MUSCLE_1, null, 0,0);</span>
<span class="nc" id="L405">                    graphicsEngine.drawModuleStats(module);</span>
<span class="nc" id="L406">                } catch (InvalidModuleEnumException ex) {</span>
<span class="nc" id="L407">                    Logger.getLogger(GameEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L408">                }</span>
<span class="nc" id="L409">            }</span>
        });
<span class="nc" id="L411">        muscleav.setOnMouseExited(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
<span class="nc" id="L415">                graphicsEngine.drawModuleStats(null);</span>
<span class="nc" id="L416">            }</span>
        });
        
<span class="nc" id="L419">        ImageView pausebutton = (ImageView)graphicsEngine.getNode(&quot;btnPause&quot;,null);</span>
<span class="nc" id="L420">        pausebutton.setOnMouseClicked(new EventHandler&lt;MouseEvent&gt;(){</span>

            @Override
            public void handle(MouseEvent event) {
<span class="nc bnc" id="L424" title="All 2 branches missed.">                gameRunning = !gameRunning;</span>
<span class="nc" id="L425">                graphicsEngine.setPauseButton(gameRunning);</span>
<span class="nc" id="L426">            }</span>
        
        });
<span class="nc" id="L429">    }</span>
    
    /**
     * Starts the game. From this point, the initial wave will be created and the game will run from this point on.
     */
    private void startGame(){
<span class="nc" id="L435">        gameRunning = true;        </span>
        
<span class="nc" id="L437">        Wave w = generateNextWave();</span>
<span class="nc" id="L438">        waveList.add(w);</span>
<span class="nc" id="L439">        currentWave = w;</span>
<span class="nc" id="L440">        w.startWave();</span>
        
<span class="nc" id="L442">    }</span>
    
    @Override
    public void run() {
<span class="nc" id="L446">        Timer timer = new Timer();</span>
<span class="nc" id="L447">        timer.schedule(new TimerTask() {</span>

            @Override
            public void run() {
<span class="nc" id="L451">                tick();</span>
<span class="nc" id="L452">                System.out.print(&quot;use javaFX thread (gameEngine line 157) (animationTimer)&quot;);</span>
<span class="nc" id="L453">            }</span>
        }, 0, 15);
        
<span class="nc" id="L456">    }</span>
    
    private void tick(){
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if(gameRunning)</span>
        {
<span class="nc bnc" id="L461" title="All 2 branches missed.">            if(playerA.getHealth() &lt;= 0)</span>
            {
<span class="nc" id="L463">               graphicsEngine.showEndGame(playerA.getName());</span>
<span class="nc" id="L464">               gameRunning = false;</span>
               
            }

<span class="nc bnc" id="L468" title="All 4 branches missed.">            if(!currentWave.waveActive() || GameTime.getElapsedTime() &gt;= (lastWaveStart + 30000)){</span>
<span class="nc" id="L469">                Wave w = generateNextWave();</span>
<span class="nc" id="L470">                lastWaveStart = GameTime.getElapsedTime();</span>
<span class="nc" id="L471">                waveList.add(w);</span>
<span class="nc" id="L472">                currentWave = w;</span>
<span class="nc" id="L473">                w.startWave();</span>

            }

<span class="nc" id="L477">            processUnsubscribers();</span>
<span class="nc" id="L478">            notifyListeners();</span>
<span class="nc" id="L479">            fillLabels();</span>
        }
<span class="nc" id="L481">    }</span>
    
    public Wave getActiveWave(){
<span class="fc" id="L484">        return currentWave;</span>
    }
    
    public ArrayList&lt;Wave&gt; getActiveWaves() {
<span class="nc" id="L488">        ArrayList&lt;Wave&gt; result = new ArrayList&lt;Wave&gt;();</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        for (Wave w : this.waveList) {</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">            if (w.waveActive()) result.add(w);</span>
<span class="nc" id="L491">        }</span>
<span class="nc" id="L492">        return result;</span>
    }
    
    private Wave generateNextWave(){
        // calculates how strong this wave should be and ups  waveNumber by one
<span class="nc" id="L497">        int waveStrongness = 5 + (int)(0.5 * ++waveNumber * waveNumber);</span>
<span class="nc" id="L498">        int bytes = 0;</span>
<span class="nc" id="L499">        int kiloBytes = 0;</span>
<span class="nc" id="L500">        int megaBytes = 0;</span>
<span class="nc" id="L501">        int gigaBytes = 0;</span>
<span class="nc" id="L502">        int teraBytes = 0;</span>
<span class="nc" id="L503">        int petaBytes = 0;</span>
<span class="nc" id="L504">        Random r = new Random();</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">        while(waveStrongness  &gt; 100) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">            if (r.nextDouble() &gt; 0.5) {</span>
<span class="nc" id="L507">                ++petaBytes;</span>
<span class="nc" id="L508">                waveStrongness -= 32;</span>
            } else {
<span class="nc" id="L510">                ++teraBytes;</span>
<span class="nc" id="L511">                waveStrongness -= 16;</span>
            }
        }
<span class="nc bnc" id="L514" title="All 2 branches missed.">        while(waveStrongness  &gt; 50) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">            if (r.nextDouble() &gt; 0.5) {</span>
<span class="nc" id="L516">                ++teraBytes;</span>
<span class="nc" id="L517">                waveStrongness -= 16;</span>
            } else {
<span class="nc" id="L519">                ++gigaBytes;</span>
<span class="nc" id="L520">                waveStrongness -= 8;</span>
            }
        }
<span class="nc bnc" id="L523" title="All 2 branches missed.">        while(waveStrongness  &gt; 25) {</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">            if (r.nextDouble() &gt; 0.5) {</span>
<span class="nc" id="L525">                ++gigaBytes;</span>
<span class="nc" id="L526">                waveStrongness -= 8;</span>
            } else {
<span class="nc" id="L528">                ++megaBytes;</span>
<span class="nc" id="L529">                waveStrongness -= 4;</span>
            }
        }
<span class="nc bnc" id="L532" title="All 2 branches missed.">        while(waveStrongness  &gt; 10) {</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">            if (r.nextDouble() &gt; 0.25) {</span>
<span class="nc" id="L534">                ++megaBytes;</span>
<span class="nc" id="L535">                waveStrongness -= 4;</span>
            } else {
<span class="nc" id="L537">                ++kiloBytes;</span>
<span class="nc" id="L538">                waveStrongness -= 2;</span>
            }
        }
<span class="nc bnc" id="L541" title="All 2 branches missed.">        while(waveStrongness  &gt; 5) {</span>
<span class="nc" id="L542">                ++kiloBytes;</span>
<span class="nc" id="L543">                waveStrongness -= 2;</span>
        }
<span class="nc bnc" id="L545" title="All 2 branches missed.">        while (waveStrongness &gt; 0) {</span>
<span class="nc" id="L546">            ++bytes;</span>
<span class="nc" id="L547">            waveStrongness -= 1;</span>
        }
<span class="nc" id="L549">        System.out.println(bytes + &quot; : &quot; + kiloBytes + &quot; : &quot; +megaBytes + &quot; : &quot; +gigaBytes + &quot; : &quot; + teraBytes + &quot; : &quot; + petaBytes); // for logging purpose</span>
        
<span class="nc" id="L551">        return new Wave(waveNumber,1 + 0.1*waveNumber,playerA,bytes,kiloBytes,megaBytes,gigaBytes,teraBytes,petaBytes);</span>
    }
    
    /**
     * Returns the player object from the player that's currently playing. So no enemy Player is returned.
     * @return Current user
     */
    public Player getPlayer(){
<span class="nc" id="L559">        return playerA;</span>
    }
    
    public void setOnTickListener(OnExecuteTick callback){
<span class="nc" id="L563">        listeners.add(callback);</span>
<span class="nc" id="L564">    }</span>
    
    public void setOnTickCompleteListener(OnCompleteTick callback){
<span class="nc" id="L567">        tickCompleteListeners.add(callback);</span>
<span class="nc" id="L568">    }</span>
    /**
     * Removes the unsubscribers from the listeners list.
     * This method should not be called during a tick therefor only after a tick!
     */
    private void processUnsubscribers(){
<span class="nc bnc" id="L574" title="All 2 branches missed.">        if(unsubscribedListeners.size() &gt; 0 ){</span>
<span class="nc" id="L575">            listeners.removeAll(unsubscribedListeners);</span>
<span class="nc" id="L576">            unsubscribedListeners.clear();</span>
        }
<span class="nc bnc" id="L578" title="All 2 branches missed.">        if(unsubscribedCompleteListeners.size() &gt; 0){</span>
<span class="nc" id="L579">            tickCompleteListeners.removeAll(unsubscribedCompleteListeners);</span>
<span class="nc" id="L580">            unsubscribedCompleteListeners.clear();</span>
        }
<span class="nc" id="L582">    }</span>
    
    public boolean unsubscribeListener(OnExecuteTick callback) throws UnsubscribeNonListenerException{
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if(!listeners.contains(callback)){</span>
<span class="nc" id="L586">            throw new UnsubscribeNonListenerException(&quot;You try to unsubscribe a listener that is not subscribed as a listener&quot;);</span>
        }
<span class="nc" id="L588">        unsubscribedListeners.add(callback);</span>
<span class="nc" id="L589">        return true;</span>
    }
    
    public boolean unsubscribeListener(OnCompleteTick callback) throws UnsubscribeNonListenerException{
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if(!tickCompleteListeners.contains(callback)){</span>
<span class="nc" id="L594">            throw new UnsubscribeNonListenerException(&quot;You try to unsubscribe a listener that is not subscribed as a listener&quot;);</span>
        }
<span class="nc" id="L596">        unsubscribedCompleteListeners.add(callback);</span>
<span class="nc" id="L597">        return true;</span>
    }
    
    /**
     * Notifies every listening object that a tick occured.
     */
    private void notifyListeners(){
<span class="nc" id="L604">        Iterator&lt;OnExecuteTick&gt; listit = listeners.iterator();</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        while(listit.hasNext()){</span>
<span class="nc" id="L606">            OnExecuteTick l = listit.next();</span>
<span class="nc" id="L607">            l.onTick(GameTime.getElapsedTime());</span>
<span class="nc" id="L608">        }</span>
<span class="nc" id="L609">        Iterator&lt;OnCompleteTick&gt; compit = tickCompleteListeners.iterator();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        while(compit.hasNext()){</span>
<span class="nc" id="L611">            OnCompleteTick cl = compit.next();</span>
<span class="nc" id="L612">            cl.tickComplete(GameTime.getElapsedTime());</span>
<span class="nc" id="L613">        }</span>
<span class="nc" id="L614">    }</span>
    
    /**
     * Adds the effect of the spell to every targeted minion in the range of this spell.
     * @param spell The spell to perform.
     */
    public void executeSpell(Spell spell){
        
<span class="nc" id="L622">    }</span>
    
    private void fillLabels(){
<span class="nc" id="L625">        String name = playerA.getName();</span>
<span class="nc" id="L626">        double health = playerA.getHealth();</span>
<span class="nc" id="L627">        double coins = playerA.getBitcoins();</span>
<span class="nc" id="L628">        int wave = currentWave.getWaveNr();</span>
<span class="nc" id="L629">        graphicsEngine.drawLabels(wave, name, health, coins);</span>
<span class="nc" id="L630">    }</span>
    
    /**
     * Calculates if there is an existing node in the given square
     * @param x the x-location of the left upper corner
     * @param y the y-location of the left upper corner
     * @param width the width of the square
     * @param height the height of the square
     * @return whether or not the given square is overlapping an existing node
     */
    private boolean isPointInNode(int x, int y, int width, int height) {
<span class="nc" id="L641">            ObservableList&lt;Node&gt; nodes = graphicsEngine.getNodes();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">            for(Node n : nodes)</span>
            {
<span class="nc bnc" id="L644" title="All 4 branches missed.">                if(n instanceof ModuleImage || n instanceof PathImage)</span>
                {
<span class="nc" id="L646">                    Point2D p1 = new Point2D(x, y); // left upper corner</span>
<span class="nc" id="L647">                    Point2D p2 = new Point2D(x, y + height); // left bottom corner</span>
<span class="nc" id="L648">                    Point2D p3 = new Point2D(x + width, y); // right upper corner</span>
<span class="nc" id="L649">                    Point2D p4 = new Point2D(x + width, y + height); // right bottom corner</span>
<span class="nc" id="L650">                    Point2D p5 = new Point2D(x + 0.5*width, y + 0.5*height); // the middle</span>
<span class="nc bnc" id="L651" title="All 10 branches missed.">                    boolean b = n.contains(p1) || n.contains(p2) || n.contains(p3) || n.contains(p4) || n.contains(p5);</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">                    if (b) return true;</span>
                }
<span class="nc" id="L654">            }</span>
<span class="nc" id="L655">            return false;</span>
    }
    
    public boolean gameRunning(){
<span class="nc" id="L659">        return gameRunning;</span>
    }
    
    @Override
    public void mouseClicked(java.awt.event.MouseEvent e) {
<span class="nc" id="L664">        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.</span>
    }

    @Override
    public void mousePressed(java.awt.event.MouseEvent e) {
<span class="nc" id="L669">        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.</span>
    }

    @Override
    public void mouseReleased(java.awt.event.MouseEvent e) {
<span class="nc" id="L674">        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.</span>
    }

    @Override
    public void mouseEntered(java.awt.event.MouseEvent e) {
<span class="nc" id="L679">        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.</span>
    }

    @Override
    public void mouseExited(java.awt.event.MouseEvent e) {
<span class="nc" id="L684">        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;); //To change body of generated methods, choose Tools | Templates.</span>
    }
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>