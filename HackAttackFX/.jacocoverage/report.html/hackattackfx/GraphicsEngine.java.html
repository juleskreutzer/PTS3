<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GraphicsEngine.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;HackAttackFX&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">hackattackfx</a> &gt; <span class="el_source">GraphicsEngine.java</span></div><h1>GraphicsEngine.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package hackattackfx;

import hackattackfx.enums.ModuleName;
import java.util.List;
import hackattackfx.exceptions.*;
import java.io.File;
import java.util.Iterator;
import java.util.Timer;
import java.util.TimerTask;
import java.util.logging.Level;
import java.util.logging.Logger;
import javafx.application.Platform;
import javafx.collections.ObservableList;
import javafx.scene.Node;
import javafx.scene.control.Label;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.shape.*;
import javafx.scene.text.Text;

/**
 *
 * @author Jasper Rouwhorst
 */
public class GraphicsEngine{
    
    private FXMLDocumentController parent;
    private static GraphicsEngine instance;
    // The active spawntarget image. This value is null if no spawning is in progres.
    private SpawnTargetImage spawnTarget;
    // The active modulerange ellipse. This value is null if no module is hovered.
    private Ellipse moduleRange;
    private double updateTime;
    
    private Label lblCurrentWave;
    private Label lblPlayerName;
    private Label lblPlayerHealth;
    private Label lblPlayerBitcoins;
    private Label errorLabel;
    private Label lblStatsName;
    private Label lblStatsDescription;
    private Label lblStatsDamage;
    private Label lblStatsLevel;
    private Label lblStatsROF;
    private Label lblStatsEffect;
    private Label lblStatsRange;
    private Label lblStatsCosts;
    
    private ImageView errorImage;
    
<span class="fc" id="L59">    private GraphicsEngine(){</span>
<span class="fc" id="L60">        instance = this;</span>
<span class="fc" id="L61">        parent = FXMLDocumentController.getInstance();</span>
<span class="nc" id="L62">        lblCurrentWave = (Label)parent.getNode(&quot;lblCurrentWave&quot;,null);</span>
<span class="nc" id="L63">        lblPlayerName = (Label)parent.getNode(&quot;lblPlayerName&quot;,null);</span>
<span class="nc" id="L64">        lblPlayerHealth = (Label)parent.getNode(&quot;lblPlayerHealth&quot;,null);</span>
<span class="nc" id="L65">        lblPlayerBitcoins = (Label)parent.getNode(&quot;lblPlayerBitcoins&quot;,null);</span>
<span class="nc" id="L66">        lblStatsName = (Label)parent.getNode(&quot;lblStatsName&quot;,null);</span>
<span class="nc" id="L67">        lblStatsDescription = (Label)parent.getNode(&quot;lblStatsDescription&quot;,null);</span>
<span class="nc" id="L68">        lblStatsDamage = (Label)parent.getNode(&quot;lblStatsDamage&quot;,null);</span>
<span class="nc" id="L69">        lblStatsLevel = (Label)parent.getNode(&quot;lblStatsLevel&quot;,null);</span>
<span class="nc" id="L70">        lblStatsROF = (Label)parent.getNode(&quot;lblStatsROF&quot;,null);</span>
<span class="nc" id="L71">        lblStatsEffect = (Label)parent.getNode(&quot;lblStatsEffect&quot;,null);</span>
<span class="nc" id="L72">        lblStatsRange = (Label)parent.getNode(&quot;lblStatsRange&quot;,null);</span>
<span class="nc" id="L73">        lblStatsCosts = (Label)parent.getNode(&quot;lblStatsCosts&quot;,null);</span>
<span class="nc" id="L74">        errorLabel = (Label)parent.getNode(&quot;errorLabel&quot;,null);</span>
<span class="nc" id="L75">        errorImage = (ImageView)parent.getNode(&quot;errorImage&quot;,null);</span>
<span class="nc" id="L76">        File file = new File(&quot;src/hackattackfx/resources/error.png&quot;);</span>
<span class="nc" id="L77">        Image image = new Image(file.toURI().toString());</span>
<span class="nc" id="L78">        errorImage.setImage(image);</span>
<span class="nc" id="L79">        errorImage.setVisible(false);</span>
<span class="nc" id="L80">        errorLabel.setVisible(false);</span>
        
<span class="nc" id="L82">        initialize();</span>
        
<span class="nc" id="L84">    }</span>
    
    public static GraphicsEngine getInstance(){
<span class="nc bnc" id="L87" title="All 2 branches missed.">        return instance == null ? new GraphicsEngine() : instance;</span>
    }
    
    private void initialize(){
<span class="nc" id="L91">        GameEngine.getInstance().setOnTickCompleteListener(new GameEngine.OnCompleteTick() {</span>

            @Override
            public void tickComplete(long elapsedtime) {
<span class="nc" id="L95">                update();</span>
<span class="nc" id="L96">            }</span>
            
        });
<span class="nc" id="L99">    }</span>
    
    /**
     * The Scene is the main window the whole application runs in
     * @return The main AnchorPane
     */
    public AnchorPane getScene(){
<span class="nc" id="L106">        return parent.getScene();</span>
    }
    
    /**
     * Returns a node selected by the given id
     * @param id
     * @param parent
     * @return 
     */
    public Node getNode(String id, Pane p){
<span class="nc" id="L116">        Node n = parent.getNode(id, p);</span>
<span class="nc" id="L117">        return n;</span>
    }
    
    public ObservableList getNodes()
    {
<span class="nc" id="L122">        return parent.getAllNodes();</span>
    }
    
    /**
     * From the moment an object is spawned, it will be updated every tick.
     * This is the entry point for an object to be updated every tick.
     * @param object 
     * @throws hackattackfx.exceptions.DuplicateSpawnException 
     * @throws hackattackfx.exceptions.InvalidObjectException 
     */
    public void spawn(Object object) throws DuplicateSpawnException, InvalidObjectException{
        // Checks if the object doesn't exists already
<span class="nc" id="L134">        List&lt;Node&gt; list = parent.getAllNodes();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        for(Node node : list){</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if(node instanceof ObjectImage){</span>
<span class="nc" id="L137">                ObjectImage image = (ObjectImage)node;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                if(image.getReference() == object){</span>
<span class="nc" id="L139">                    throw new DuplicateSpawnException(&quot;This object already spawned!&quot;);</span>
                }
            }
<span class="nc" id="L142">        }</span>
        
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if(object instanceof Minion){</span>
<span class="nc" id="L145">            Minion m = (Minion)object;</span>
<span class="nc" id="L146">            MinionImage mi = new MinionImage(m);</span>
<span class="nc" id="L147">            parent.addNode(mi);</span>
<span class="nc" id="L148">            parent.addNode(mi.getHealthBar());</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        }else if(object instanceof Module){</span>
<span class="nc" id="L150">            Module m = (Module) object;</span>
<span class="nc" id="L151">            parent.addNode(new ModuleImage((Module)object));</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        }else if(object instanceof Spell){</span>
<span class="nc" id="L153">            parent.addNode(new SpellImage((Spell)object));</span>
        }else{
<span class="nc" id="L155">            throw new InvalidObjectException(&quot;The object you tried to spawn doesn't have a corresponding ObjectImage implementation&quot;);</span>
        }
<span class="nc" id="L157">    }</span>
    
    /**
     * Check if the give {@link Node} exists then remove it from the UI.
     * @param n The node to despawn
     */
    public void deSpawn(Node n) throws InvalidObjectException{
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if(!parent.getAllNodes().contains(n)){</span>
<span class="nc" id="L165">            throw new InvalidObjectException(&quot;The despawned object does not exist&quot;);</span>
        }
<span class="nc" id="L167">        parent.removeNode(n);</span>
<span class="nc" id="L168">    }</span>
    
    public double update(){
<span class="nc" id="L171">        draw();</span>
<span class="nc" id="L172">        return 0;</span>
    }
    
    private void draw(){
<span class="nc" id="L176">        Platform.runLater(new Runnable(){</span>
            @Override
            public void run() {
<span class="nc" id="L179">                List&lt;Node&gt; nodes = parent.getAllNodes();</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">                for(Node n : nodes){</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                    if(n instanceof MinionImage){</span>
<span class="nc" id="L183">                        MinionImage mi = (MinionImage)n;</span>
<span class="nc" id="L184">                        Rectangle hb = mi.getHealthBar();</span>
<span class="nc" id="L185">                        Minion m = ((MinionImage)n).getMinion();</span>
                        
<span class="nc bnc" id="L187" title="All 2 branches missed.">                        if (m.getHealth() &gt; 0){</span>
<span class="nc" id="L188">                            mi.setX(m.getPosition().x - (mi.getImage().getWidth()/2));</span>
<span class="nc" id="L189">                            mi.setY(m.getPosition().y - (mi.getImage().getHeight()/2));</span>
<span class="nc" id="L190">                            hb.setX(mi.getX());</span>
<span class="nc" id="L191">                            hb.setY(mi.getY()+mi.getImage().getHeight());</span>
<span class="nc" id="L192">                            hb.setWidth((mi.getImage().getWidth()/100) * m.getHealthInPercentage());</span>
                            
                        }
                        else{
                            try {
<span class="nc" id="L197">                                deSpawn(n);</span>
<span class="nc" id="L198">                                deSpawn(hb);</span>
<span class="nc" id="L199">                            } catch (InvalidObjectException ex) {</span>
<span class="nc" id="L200">                                Logger.getLogger(GraphicsEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L201">                            }</span>
                        }

<span class="nc bnc" id="L204" title="All 2 branches missed.">                    }else if(n instanceof ModuleImage){</span>
<span class="nc" id="L205">                        ModuleImage mi = (ModuleImage)n;</span>
                        
<span class="nc bnc" id="L207" title="All 2 branches missed.">                        if(mi.showRange()){</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                            if(moduleRange == null){</span>
<span class="nc" id="L209">                                drawModuleRange((Module)mi.getReference());</span>
                            }
                        }else{
                                try {
                                    // loops through all nodes, if it is an ModuleRange node, remove it.
<span class="nc" id="L214">                                        Iterator i = parent.getAllNodes().iterator();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                                        while (i.hasNext())</span>
                                        {
<span class="nc" id="L217">                                            Node node = (Node)i.next();</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                                            if (&quot;ModuleRange&quot;.equals(node.getId())) {</span>
<span class="nc" id="L219">                                                deSpawn(node);</span>
                                            }
<span class="nc" id="L221">                                        }</span>
<span class="nc" id="L222">                                    moduleRange = null;</span>
<span class="nc" id="L223">                                } catch (InvalidObjectException ex) {</span>
<span class="nc" id="L224">                                    Logger.getLogger(GraphicsEngine.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L225">                                }</span>
                        }
                        
                        
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    }else if(n instanceof SpellImage){</span>

                    }
<span class="nc" id="L232">                }</span>
<span class="nc" id="L233">            }</span>
        });
<span class="nc" id="L235">    }</span>
    
    public void showModuleStats(Module m){
<span class="nc" id="L238">        lblStatsName.setText(String.format(&quot;Name: %s&quot;,m.getName()));</span>
<span class="nc" id="L239">        lblStatsDescription.setText(String.format(&quot;Description: %s&quot;,&quot;No description available&quot;));</span>
<span class="nc" id="L240">        lblStatsLevel.setText(String.format(&quot;Level: %d&quot;,m.getLevel()));</span>
<span class="nc" id="L241">        lblStatsCosts.setText(String.format(&quot;Costs: %d&quot;,Math.round(m.getCost())));</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if(m instanceof Defense){</span>
<span class="nc" id="L243">            Defense d = (Defense)m;</span>
<span class="nc" id="L244">            lblStatsROF.setText(String.format(&quot;Rate of fire: %d&quot;,d.getFrequecy()));</span>
<span class="nc" id="L245">            lblStatsEffect.setText(String.format(&quot;Effect: %s&quot;,d.getEffectString()));</span>
<span class="nc" id="L246">            lblStatsRange.setText(String.format(&quot;Range: %d&quot;,d.getRange()));</span>
<span class="nc" id="L247">            lblStatsDamage.setText(String.format(&quot;Damage: %d&quot;,Math.round(d.getDamage())));</span>
        }
<span class="nc" id="L249">    }</span>
    
    public void drawRoad(Road road){
<span class="nc bnc" id="L252" title="All 2 branches missed.">        for(Path p : road.getPaths()){</span>
<span class="nc" id="L253">            PathImage image = new PathImage(p);</span>
<span class="nc" id="L254">            parent.addNode(image);</span>
<span class="nc" id="L255">        }</span>
<span class="nc" id="L256">    }</span>
    
    /**
     * Draws an holographic version of the module you want to build.
     * @param m The module the holographic version should be showed of
     */
    public SpawnTargetImage drawModuleSpawnTarget(ModuleName module){
        
<span class="nc" id="L264">        File file = null;</span>
        
<span class="nc" id="L266">        File unavailableFile = new File(&quot;src/hackattackfx/resources/unavailable.png&quot;);</span>
<span class="nc" id="L267">        Image unavailableTargetImage = new Image(unavailableFile.toURI().toString());</span>
        Image availableTargetImage;
        
<span class="nc bnc" id="L270" title="All 8 branches missed.">        switch(module){</span>
            case BITCOIN_MINER:
<span class="nc" id="L272">                file = new File(&quot;src/hackattackfx/resources/DefenceSpawnTarget.png&quot;);</span>
<span class="nc" id="L273">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L274">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_BITCOINMINER_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L275">                break;</span>
            case SOFTWARE_INJECTOR:
<span class="nc" id="L277">                file = new File(&quot;src/hackattackfx/resources/DefenceSpawnTarget.png&quot;);</span>
<span class="nc" id="L278">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L279">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_SOFTWAREINJECTOR_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L280">                break;</span>
            case CPU_UPGRADE:
<span class="nc" id="L282">                file = new File(&quot;src/hackattackfx/resources/DefenceSpawnTarget.png&quot;);</span>
<span class="nc" id="L283">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L284">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_CPUUPGRADE_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L285">                break;</span>
            case SNIPER_ANTIVIRUS:
<span class="nc" id="L287">                file = new File(&quot;src/hackattackfx/resources/interface/module/40x40/sniper_module.png&quot;);</span>
<span class="nc" id="L288">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L289">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_DEFENSE_SNIPER_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L290">                break;</span>
            case BOTTLECAP_ANTIVIRUS:
<span class="nc" id="L292">                file = new File(&quot;src/hackattackfx/resources/interface/module/40x40/bottlecap_module.png&quot;);</span>
<span class="nc" id="L293">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L294">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_DEFENSE_BOTTLECAP_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L295">                break;</span>
            case SCALE_ANTIVIRUS:
<span class="nc" id="L297">                file = new File(&quot;src/hackattackfx/resources/interface/module/40x40/scale_module.png&quot;);</span>
<span class="nc" id="L298">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L299">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_DEFENSE_SCALE_1, unavailableTargetImage, availableTargetImage);</span>
<span class="nc" id="L300">                break;</span>
            case MUSCLE_ANTIVIRUS:
<span class="nc" id="L302">                file = new File(&quot;src/hackattackfx/resources/interface/module/40x40/muscle_module.png&quot;);</span>
<span class="nc" id="L303">                availableTargetImage = new Image(file.toURI().toString());</span>
<span class="nc" id="L304">                spawnTarget = new SpawnTargetImage(Data.DEFAULT_MODULE_DEFENSE_MUSCLE_1, unavailableTargetImage, availableTargetImage);</span>
                break;
        }
        
<span class="nc" id="L308">        Image targetimage = new Image(file.toURI().toString());</span>
<span class="nc" id="L309">        spawnTarget.setImage(targetimage);</span>
<span class="nc" id="L310">        spawnTarget.setOpacity(0.5);</span>
<span class="nc" id="L311">        parent.addNode(spawnTarget);</span>
        
<span class="nc" id="L313">        return spawnTarget;</span>
    }
    
    public Ellipse drawModuleRange(Module module){
<span class="nc" id="L317">        Ellipse rangecircle = null;</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if(module instanceof Defense){</span>
<span class="nc" id="L319">            Defense defense = (Defense)module;</span>
<span class="nc" id="L320">            rangecircle = new Ellipse(defense.getRange(), defense.getRange());</span>
        }
<span class="nc" id="L322">        rangecircle.setCenterX(module.getPosition().x);</span>
<span class="nc" id="L323">        rangecircle.setCenterY(module.getPosition().y);</span>
<span class="nc" id="L324">        rangecircle.setStroke(Color.BLACK);</span>
<span class="nc" id="L325">        rangecircle.setFill(null);</span>
<span class="nc" id="L326">        rangecircle.setStrokeWidth(3);</span>
<span class="nc" id="L327">        rangecircle.setId(&quot;ModuleRange&quot;);</span>
<span class="nc" id="L328">        moduleRange = rangecircle;</span>
<span class="nc" id="L329">        parent.addNode(rangecircle);</span>
<span class="nc" id="L330">        return rangecircle;</span>
    }
    
    public void drawSpellRange(Spell spell){
        
<span class="nc" id="L335">    }</span>
    
    public void drawLabels(int wavenr, String name, double health, double bitcoins){
<span class="nc" id="L338">        Platform.runLater(new Runnable(){</span>

            @Override
            public void run() {
<span class="nc" id="L342">                lblCurrentWave.setText(String.format(&quot;Wave: %d&quot;, wavenr));</span>
<span class="nc" id="L343">                lblPlayerName.setText(String.format(&quot;Playername: %s&quot;, name));</span>
<span class="nc" id="L344">                lblPlayerHealth.setText(String.format(&quot;Health: %s&quot;, health));</span>
<span class="nc" id="L345">                lblPlayerBitcoins.setText(String.format(&quot;Bitcoins: %s&quot;, bitcoins));</span>
<span class="nc" id="L346">            }</span>
        });
        
<span class="nc" id="L349">    }</span>
    
    public void showEndGame(String name)
    {
<span class="nc" id="L353">        Platform.runLater(new Runnable(){</span>

            @Override
            public void run() {

<span class="nc" id="L358">                Text text = new Text();</span>
<span class="nc" id="L359">                text.setText(String.format(&quot;Game over, %s&quot;, name));</span>
<span class="nc" id="L360">                text.setFill(Color.RED);</span>
<span class="nc" id="L361">                text.setStyle(&quot;-fx-font-size: 40&quot;);</span>
<span class="nc" id="L362">                double height = parent.getScene().getHeight();</span>
<span class="nc" id="L363">                double width = parent.getScene().getWidth();</span>
<span class="nc" id="L364">                height -= 40;</span>
<span class="nc" id="L365">                width -= 280;</span>
<span class="nc" id="L366">                text.setLayoutX(width/2);</span>
<span class="nc" id="L367">                text.setLayoutY(height/2);</span>
                
<span class="nc" id="L369">                parent.addNode(text);</span>
<span class="nc" id="L370">            }            </span>
        });
<span class="nc" id="L372">    }</span>

    
    /**
     * Display an error message for the user. First show the error image and error label, than, after 5 seconds, make them magicaly disappear
     * @param message Error message to be shown
     */
    public void showError(String message)
    {
<span class="nc" id="L381">        Timer timer = new Timer();</span>
        
        
<span class="nc" id="L384">        Platform.runLater(new Runnable(){</span>
            @Override
            public void run() {
<span class="nc" id="L387">                errorImage.setVisible(true);</span>
<span class="nc" id="L388">                errorLabel.setText(String.format(&quot;%s&quot;, message));</span>
<span class="nc" id="L389">                errorLabel.setVisible(true);</span>
<span class="nc" id="L390">            }</span>
        });
        
<span class="nc" id="L393">        timer.scheduleAtFixedRate(new TimerTask(){</span>

            @Override
            public void run() {
<span class="nc" id="L397">                errorImage.setVisible(false);</span>
<span class="nc" id="L398">                errorLabel.setVisible(false);</span>
<span class="nc" id="L399">            }</span>
            
        }, 0 , 5000);
<span class="nc" id="L402">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>